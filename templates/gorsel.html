{% extends "base.html" %}
{% block title %}GÃ¶rsel OluÅŸturma - KralZeka{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card p-4 shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>ğŸ¨ GÃ¶rsel OluÅŸturma & Kalite YÃ¼kseltme</h4>
      <a href="{{ url_for('index') }}" class="btn btn-sm btn-secondary">Ana Sayfa</a>
    </div>

    <p class="text-muted">Yeni bir gÃ¶rsel oluÅŸturmak iÃ§in aÃ§Ä±klama yazÄ±n. Mevcut gÃ¶rselin kalitesini yÃ¼kseltmek iÃ§in dosya yÃ¼kleyin.</p>

    <!-- GÃ¶rsel OluÅŸturma -->
    <div class="row g-3 mb-3">
      <div class="col-md-8">
        <label class="form-label">ğŸ–Šï¸ GÃ¶rsel AÃ§Ä±klamasÄ± (Prompt)</label>
        <input type="text" id="gen-prompt" class="form-control" placeholder="Ã–rnek: 'GÃ¼n batÄ±mÄ±nda uÃ§an ÅŸehir, sinematik, yÃ¼ksek detay'">
      </div>
      <div class="col-md-4">
        <label class="form-label">Boyut</label>
        <select id="gen-size" class="form-control">
          <option value="512x512">512 x 512</option>
          <option value="768x768">768 x 768</option>
          <option value="1024x1024" selected>1024 x 1024</option>
        </select>
      </div>
      <div class="col-12">
        <button id="gen-btn" class="btn btn-primary">ğŸª„ GÃ¶rsel OluÅŸtur</button>
      </div>
    </div>

    <hr>

    <!-- Kalite YÃ¼kseltme -->
    <div class="row g-3 mb-3">
      <div class="col-md-8">
        <label class="form-label">ğŸ“ Varolan GÃ¶rsel SeÃ§ (Kalite YÃ¼kseltme)</label>
        <input type="file" id="up-image" class="form-control" accept="image/*">
      </div>
      <div class="col-md-4">
        <label class="form-label">Seviye</label>
        <select id="up-level" class="form-control">
          <option value="1">+1 (hafif)</option>
          <option value="2" selected>+2 (orta)</option>
          <option value="3">+3 (yÃ¼ksek)</option>
        </select>
      </div>
      <div class="col-12">
        <button id="up-btn" class="btn btn-info">â¬†ï¸ Kaliteyi YÃ¼kselt</button>
        <small class="d-block mt-2 text-muted">Not: Normal kullanÄ±cÄ±lar gÃ¼nlÃ¼k <strong>{{ image_limit }}</strong> hakkÄ±na sahiptir. Admin sÄ±nÄ±rsÄ±z.</small>
      </div>
    </div>

    <hr>

    <!-- SonuÃ§ -->
    <div class="mb-3">
      <h5>ğŸ–¼ï¸ SonuÃ§</h5>
      <div id="result-area" class="p-3 border" style="min-height:120px;">
        {% if last_image %}
          <div class="text-center">
            <img src="data:image/png;base64,{{ last_image }}" alt="KralZeka GÃ¶rsel" style="max-width:100%;height:auto;border-radius:8px">
          </div>
        {% else %}
          <div class="muted">HenÃ¼z oluÅŸturulmuÅŸ bir gÃ¶rsel yok.</div>
        {% endif %}
      </div>
    </div>

    <!-- Ek Ayarlar / Bilgiler -->
    <div class="small text-muted">
      <p><strong>Ä°pucu:</strong> Prompt'Ä± kÄ±sa ve aÃ§Ä±klayÄ±cÄ± tut. Stil (Ã¶r. "sinematik", "watercolor", "photorealistic") ve objeler arasÄ±na virgÃ¼l koy.</p>
      <p><strong>Gizlilik:</strong> YalnÄ±zca yÃ¼klediÄŸiniz gÃ¶rseller hafÄ±zaya alÄ±nÄ±r (isteÄŸe baÄŸlÄ± / profil ayarÄ±ndan kontrol edilebilir).</p>
    </div>
  </div>
</div>

<script>
  // Basit frontend â€” backend endpoint'lerini projene gÃ¶re baÄŸla:
  // OluÅŸturma: POST /api/generate_image  { prompt, size }
  // Kalite yÃ¼kseltme: POST /api/upgrade_image { image (file), level }
  document.getElementById('gen-btn').addEventListener('click', async () => {
    const prompt = document.getElementById('gen-prompt').value.trim();
    const size = document.getElementById('gen-size').value;
    if (!prompt) return alert('LÃ¼tfen bir aÃ§Ä±klama gir.');
    const btn = document.getElementById('gen-btn');
    btn.disabled = true; btn.textContent = 'OluÅŸturuluyor...';
    try {
      const res = await fetch('/api/generate_image', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({prompt, size})
      });
      const data = await res.json();
      if (res.ok && data.image_base64) {
        document.getElementById('result-area').innerHTML = '<img src="data:image/png;base64,'+data.image_base64+'" style="max-width:100%;border-radius:8px">';
      } else {
        alert('GÃ¶rsel Ã¼retilemedi: ' + (data.error || res.statusText));
      }
    } catch (e) {
      alert('Ä°stek sÄ±rasÄ±nda hata: ' + e.message);
    } finally {
      btn.disabled = false; btn.textContent = 'ğŸª„ GÃ¶rsel OluÅŸtur';
    }
  });

  document.getElementById('up-btn').addEventListener('click', async () => {
    const fileInput = document.getElementById('up-image');
    if (!fileInput.files || !fileInput.files[0]) return alert('LÃ¼tfen bir gÃ¶rsel seÃ§in.');
    const level = document.getElementById('up-level').value;
    const btn = document.getElementById('up-btn');
    btn.disabled = true; btn.textContent = 'YÃ¼kseltiliyor...';
    try {
      const form = new FormData();
      form.append('image', fileInput.files[0]);
      form.append('level', level);
      const res = await fetch('/api/upgrade_image', { method: 'POST', body: form });
      const data = await res.json();
      if (res.ok && data.image_base64) {
        document.getElementById('result-area').innerHTML = '<img src="data:image/png;base64,'+data.image_base64+'" style="max-width:100%;border-radius:8px">';
      } else {
        alert('Kalite yÃ¼kseltilemedi: ' + (data.error || res.statusText));
      }
    } catch (e) {
      alert('Ä°stek sÄ±rasÄ±nda hata: ' + e.message);
    } finally {
      btn.disabled = false; btn.textContent = 'â¬†ï¸ Kaliteyi YÃ¼kselt';
    }
  });
</script>
{% endblock %}
